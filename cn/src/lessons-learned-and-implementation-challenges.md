## 经验教训与实现挑战

构建智能体系统会暴露出一些值得特别指出的棘手工程问题：

### 异步复杂性

异步生成器很强大，但也增加了复杂度。行之有效的做法：
	•	显式取消：始终清晰地处理中止信号。
	•	背压控制：谨慎处理流式传输以避免内存泄漏。
	•	测试生成器：常规工具不够用，你很可能需要专门的测试工具。

结构良好的异步生成器示例：

```js
async function* generator(signal: AbortSignal): AsyncGenerator<Result> {
  try {
    while (moreItems()) {
      if (signal.aborted) throw new AbortError();
      yield await processNext();
    }
  } finally {
    await cleanup();
  }
}
```

### 工具系统设计

好的工具需要在强大和避免误操作之间取得平衡。架构通过以下方式实现：
	•	权限设计清晰但不过度细粒度。
	•	通过结构化定义使工具易于发现。

### 终端 UI 挑战

终端看起来很简单，但 UI 复杂性会悄然累积：
	•	不同终端意味着兼容性方面的各种头疼问题。
	•	键盘输入和状态管理需要精心处理。

### 与 LLM 的集成

LLM 是非确定性的。防御性编码很有帮助：
	•	健壮的解析很重要，不要盲目信任输出。
	•	谨慎管理上下文窗口的限制。

### 性能考量

保持工具的响应性至关重要：
	•	谨慎地进行并行化，管理好资源使用。
	•	实现快速取消以提升响应性。

希望这些洞察能帮你在探索类似想法时少走一些弯路。

